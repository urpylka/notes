<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><meta property="og:site_name" content="urpylka՚s blog!" data-vmid="og:site_name"><title>Upgrade и миграция Grafana с SQLite в PostgreSQL – urpylka՚s blog!</title><meta property="og:title" content="Upgrade и миграция Grafana с SQLite в PostgreSQL" />
<meta property="og:description" content="Последний месяц я занимался миграцией Grafana. Оказалось перенести базу не так просто, как я рассчитывал и читал в статьях. Под катом, как я это делал." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://urpylka.com/posts/post-78/" />
<meta property="article:published_time" content="2022-10-28T16:13:00+02:00" />
<meta property="article:modified_time" content="2022-10-28T16:13:00+02:00" /><meta property="og:site_name" content="urpylka՚s blog!" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Upgrade и миграция Grafana с SQLite в PostgreSQL"/>
<meta name="twitter:description" content="Последний месяц я занимался миграцией Grafana. Оказалось перенести базу не так просто, как я рассчитывал и читал в статьях. Под катом, как я это делал."/>
<link rel="icon" type="image/x-icon" href="https://urpylka.com/favicon.ico" />
	<link rel="apple-touch-icon" sizes="57x57" href="https://urpylka.com/favicon/apple-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="https://urpylka.com/favicon/apple-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="https://urpylka.com/favicon/apple-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="https://urpylka.com/favicon/apple-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="https://urpylka.com/favicon/apple-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="https://urpylka.com/favicon/apple-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144" href="https://urpylka.com/favicon/apple-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152" href="https://urpylka.com/favicon/apple-icon-152x152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="https://urpylka.com/favicon/apple-icon-180x180.png">
	<link rel="icon" type="image/png" sizes="192x192"  href="https://urpylka.com/favicon/android-icon-192x192.png">
	<link rel="icon" type="image/png" sizes="32x32" href="https://urpylka.com/favicon/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="96x96" href="https://urpylka.com/favicon/favicon-96x96.png">
	<link rel="icon" type="image/png" sizes="16x16" href="https://urpylka.com/favicon/favicon-16x16.png">
	<link rel="manifest" href="https://urpylka.com/favicon/manifest.json">
	<meta name="msapplication-TileColor" content="#ffffff">
	<meta name="msapplication-TileImage" content="https://urpylka.com/favicon/ms-icon-144x144.png">
	<meta name="theme-color" content="#ffffff"><meta name="viewport" content="width=device-width, initial-scale=1"><meta itemprop="name" content="Upgrade и миграция Grafana с SQLite в PostgreSQL">
<meta itemprop="description" content="Последний месяц я занимался миграцией Grafana. Оказалось перенести базу не так просто, как я рассчитывал и читал в статьях. Под катом, как я это делал.">
<meta itemprop="datePublished" content="2022-10-28T16:13:00&#43;02:00" />
<meta itemprop="dateModified" content="2022-10-28T16:13:00&#43;02:00" />
<meta itemprop="wordCount" content="2539">



<meta itemprop="keywords" content="ru,programming," /><link rel="stylesheet" type="text/css" media="screen" href="https://urpylka.com/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://urpylka.com/css/main.css" />
	<link rel="stylesheet" type="text/css" id="dark-scheme" href="https://urpylka.com/css/dark.css" />
	<link rel="stylesheet" type="text/css" href="https://urpylka.com/css/medium-font.css" />
<script type="text/javascript" >
	(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
	m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
	(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
ym("62022457", "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true,
        webvisor:true
});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/62022457" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-163829261-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

	<script src="https://urpylka.com/js/feather.min.js"></script><script src="https://urpylka.com/js/main.js"></script></head>


<body>
    <div class="container wrapper">
        <div class="header"><div class="flex-block">
		<div class="site-title"><a href="https://urpylka.com/">urpylka՚s blog!</a></div>
		<nav class="nav ico">
			<ul class="flat"><li><a href="https://github.com/urpylka" title="Github"><i data-feather="github"></i></a></li><li><a href="https://instagram.com/urpylka" title="Instagram"><i data-feather="instagram"></i></a></li><li class="edge-left"><span class="scheme-toggle"><a href="#" id="scheme-toggle"></a></span></li>
			</ul>
		</nav>
	</div><p id="subtitle">Programming, robotics, traveling</p><nav class="nav menu">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">Posts</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


        <div class="post one">
            <div class="post-header">
                
                <div class="meta">
                    <div class="date">
                        <span class="day">28</span>
                        <span class="rest">Oct 2022</span>
                    </div>
                </div>
                
                <div class="matter">
                    <h1 class="title">Upgrade и миграция Grafana с SQLite в PostgreSQL</h1>
                </div>
            </div>

            <div class="markdown">
                <p>Последний месяц я на работе в основном занимаюсь миграцией Grafana. Одна из задач в связи с этим – перенести данные из <code>Grafana 7.5.9</code> использующую SQLite в <code>Grafana 9.2.0</code> с PostgreSQL. Оказалось перенести базу не так просто, как я рассчитывал и читал в статьях других авторов. Что до официальной документации то, она отсуствует, есть разве что <a href="https://grafana.com/blog/2020/01/13/how-to-migrate-your-configuration-database/">о миграции из PostgreSQL в MySQL</a>.</p>
<p>Решение которое первом попалось:</p>
<ol>
<li><a href="https://community.zenduty.com/t/migrating-grafanas-database-from-sqlite-to-postgres/406">Migrating Grafana’s database from sqlite to postgres</a></li>
<li><a href="https://polyglot.jamie.ly/programming/2019/07/01/grafana-sqlite-to-postgres.html">Grafana SQLite Migration to PostgreSQL</a></li>
</ol>
<p>В кратце оно предлагает следующий подход:</p>
<ol>
<li>Создание схемы базы запуском графаны с использованием PostgreSQL.</li>
<li>Конвертация и загрузка SQLite базы в PosgreSQL с применением <a href="https://pgloader.readthedocs.io/en/latest/">pgloader</a></li>
</ol>
<p>Однако как я не пытался это сделать, у меня <code>pgloader</code> падал со всевозможными ошибками в середине процесса рандомно и частично мигрировав какую-то часть данных. Полагаю это связано с тем, что находится в базе SQLite (есть ли незаэкранированные последовательности итд), если ничего сверхестественного нет, то все может пройти успешно.</p>
<p>Я попробовал разные настройки <code>pgloader</code> лучший результат у меня был при использовании следующей конструкции (так pgloader не вылетал по памяти):</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">load database
  from sqlite://&lt;ABSOLUTE_PATH&gt;/grafana.db
  into postgresql://&lt;DBUSER&gt;:&lt;DBPASS&gt;@&lt;DBURL&gt;:&lt;DBPORT&gt;/&lt;DBNAME&gt;
  with data only, reset sequences
  set work_mem to &#39;16MB&#39;, maintenance_work_mem to &#39;512 MB&#39;;
</code></pre></div><p>Однако запустить так, чтобы корректно отработал <code>pgloader</code> у меня так и не получилось, и я понял, что нужен другой подход. Первой идеей, которая приходила на ум было - копировать дашборды и источники данных из интерфейса. К сожалению это было нереально. Во-первых, по причине того, что только дашбордов ≈1300 штук, а во-вторых имелось большое количество других сущностей вроде бекапов дашбордов, папок с правами и пользотелями, аннотаций, алертов итд.</p>
<p>Далее я попробовал мигрировать данные через конвертацию в csv файлы, однако было много неэкранированных последовательностей, которые не давали нормально отделять поля друг от друга.</p>
<p>Источники:</p>
<ul>
<li><a href="https://www.anycodings.com/1questions/2630266/convert-sqlite-3-database-to-csv">Convert SQLite 3 database to CSV</a></li>
<li><a href="https://www.sqlitetutorial.net/sqlite-export-csv/">Export SQLite Database To a CSV File</a></li>
</ul>
<p>В скоре я наткнулся на <a href="https://scicoding.com/migrating-from-sqlite-to-postgrse/">статью</a>, предлагающую использование <a href="https://github.com/wbh1/grafana-sqlite-to-postgres">скрипта на Golang</a>.</p>
<p>Но опять, скрипт прерывался ошибкой. Я попробовал использовать готовый docker образ, собрать программу из исходников, но безуспешно.</p>
<p>Однако я решил изучить, что делает программа и исправить. Посмотрев исходный код, я понял что ничего сложного нет, это программа просто выполняет поиск по регуляркам, и что-то правит.</p>
<p>Я плохо пишу на Golang, и для решения конвертации бд, где возможно постоянно нужно делать правки в код я решил использовать интерпретируемый язык - Python. И действие за действием перенести и исправить программу на Golang.</p>
<p>Ниже я приеду код программы по блокам и прокомментирую процесс.</p>
<p>Сразу оговорюсь, что не считаю свой скрипт и это решение готовым решением для миграции. Поэтому я подаю это как конструктор, который в случае неработоспобсности можно самостоятельно допилить напильником под свои нужды.</p>
<h2 id="полученное-решение">Полученное решение</h2>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#008000">#! /usr/bin/env python3</span>
<span style="color:#00f">import</span> re, time

srcfile = <span style="color:#a31515">&#34;./grafana.sql&#34;</span>
resfile = <span style="color:#a31515">&#34;./resfile.sql&#34;</span>

<span style="color:#00f">print</span>(<span style="color:#a31515">&#34;</span><span style="color:#a31515">\033</span><span style="color:#a31515">[1m#</span><span style="color:#a31515">\n</span><span style="color:#a31515"># This program is for preparing SQL converted from SQLite to PostgreSQL&#34;</span>)
<span style="color:#00f">print</span>(<span style="color:#a31515">&#34;# Source file: &#34;</span> + srcfile)
<span style="color:#00f">print</span>(<span style="color:#a31515">&#34;# Result file: &#34;</span> + resfile)
<span style="color:#00f">print</span>(<span style="color:#a31515">&#34;#</span><span style="color:#a31515">\033</span><span style="color:#a31515">[0;0m</span><span style="color:#a31515">\n</span><span style="color:#a31515">&#34;</span>)

last_time = int(time.time())
<span style="color:#00f">def</span> howlong():
    <span style="color:#00f">global</span> last_time
    _now = int(time.time())
    _dif = _now - last_time
    last_time = _now
    <span style="color:#00f">return</span> <span style="color:#a31515">&#34; (</span><span style="color:#a31515">%s</span><span style="color:#a31515">s)</span><span style="color:#a31515">\n</span><span style="color:#a31515">&#34;</span> % (_dif)

doings = 23
</code></pre></div><p>Это заголовочная часть скрипта. В ней вы можете видеть определение двух стандартных библиотек необходимых для обработки данных. Привественный вывод, а также опрелеление функции которая позволит нам подсчитать время выполнения действий.</p>
<p>Переменная <code>doings</code> – общее количество операций, для того, чтобы понимать сколько еще действий осталось.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#00f">with</span> open(srcfile, <span style="color:#a31515">&#39;r&#39;</span>) <span style="color:#00f">as</span> f:
    <span style="color:#00f">print</span>(<span style="color:#a31515">&#34;&gt; 1/</span><span style="color:#a31515">%d</span><span style="color:#a31515"> Uploading the source file to the memory&#34;</span> % (doings))
    content = f.read()
    <span style="color:#00f">print</span>(<span style="color:#a31515">&#34;✅ Done&#34;</span> + howlong())
</code></pre></div><p>Я писал программу не супер-эффективно с построчным чтением файла, а целиком читал файл в память, и затем уже работал. Думаю что для больниство кейсов с Grafana это подойдет. Тк даже при достаточно забитой данными Grafana SQL-дамп весит 1.3GB.</p>
<p>В случае необходимости переписать программу, не вижу необходимости обрабатывать многострочные sql-инструкции, тк все, с чем работает программа - это инструкции <code>INSERT</code>. Которые сохраняются с помощью sqlite3 всега построчно.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#00f">print</span>(<span style="color:#a31515">&#34;&gt; 2/</span><span style="color:#a31515">%d</span><span style="color:#a31515"> Deleting all statements except &#39;INSERT INTO&#39; &#34;</span> % (doings))
    match = re.compile(<span style="color:#a31515">&#34;(?m)[</span><span style="color:#a31515">\r\n</span><span style="color:#a31515">]*^(?!INSERT INTO.*)(.*)$&#34;</span>, re.IGNORECASE)
    content = match.sub(<span style="color:#a31515">&#39;&#39;</span>, content)
    <span style="color:#00f">print</span>(<span style="color:#a31515">&#34;✅ Done&#34;</span> + howlong())
</code></pre></div><p>Закономерный шаг - удаляем все строки, не начинающиеся на <code>INSERT INTO</code>.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#00f">print</span>(<span style="color:#a31515">&#34;&gt; 3/</span><span style="color:#a31515">%d</span><span style="color:#a31515"> Removing inserts to &#39;sqlite_sequence&#39;, &#39;user_auth&#39;&#34;</span> % (doings))
    match = re.compile(<span style="color:#a31515">&#34;(?m)[</span><span style="color:#a31515">\r\n</span><span style="color:#a31515">]*^INSERT INTO (sqlite_sequence|user_auth) VALUES.*;$&#34;</span>, re.IGNORECASE)
    content = match.sub(<span style="color:#a31515">&#39;&#39;</span>, content)
    <span style="color:#00f">print</span>(<span style="color:#a31515">&#34;✅ Done&#34;</span> + howlong())
</code></pre></div><p>Также удаляем данные для таблиц <code>sqlite_sequence</code> и для <code>user_auth</code>.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#00f">print</span>(<span style="color:#a31515">&#34;&gt; 4/</span><span style="color:#a31515">%d</span><span style="color:#a31515"> Fix char conversion (char -&gt; chr)&#34;</span> % (doings))
    match = re.compile(<span style="color:#a31515">&#34;char\(10\)\)&#34;</span>, re.IGNORECASE)
    content = match.sub(<span style="color:#a31515">&#39;chr(10))&#39;</span>, content)
    <span style="color:#00f">print</span>(<span style="color:#a31515">&#34;✅ Done&#34;</span> + howlong())
</code></pre></div><p>Заменяем конструкцию <code>char(10)</code> на <code>chr(10)</code> в sql-функция <code>replace</code> в соотвествии с совместимостью с Postgres.</p>
<p>Далее я предлагаю составить список таблиц, содержащих байтовые или булевы поля. Для этого посмотреть второй пункт по миграции БД ниже в статье. Для Grafana 9.2.0 у меня получился следующий список:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">bool  byte  tablename
[+]   [-]   alert
[+]   [-]   alert_configuration
[-]   [-]   alert_instance
[+]   [-]   alert_notification
[-]   [-]   alert_notification_state
[-]   [-]   alert_rule
[-]   [-]   alert_rule_version
[+]   [-]   api_key
[-]   [-]   annotation
[-]   [-]   annotation_tag
[-]   [-]   api_key
[-]   [-]   builtin_role
[+]   [-]   dashboard
[-]   [-]   dashboard_acl
[+]   [+]   dashboard_snapshot
[-]   [-]   dashboard_tag
[-]   [-]   dashboard_version
[+]   [+]   data_keys
[+]   [-]   data_source
[-]   [-]   kv_store
[+]   [-]   migration_log
[-]   [-]   org
[-]   [-]   org_user
[-]   [-]   permission
[-]   [-]   playlist
[-]   [-]   playlist_item
[+]   [-]   plugin_setting
[-]   [-]   preferences
[+]   [-]   role
[-]   [-]   secrets
[-]   [-]   server_lock
[-]   [-]   short_url
[-]   [-]   sqlite_sequence
[-]   [-]   star
[-]   [-]   tag
[-]   [-]   team
[+]   [-]   team_member
[+]   [-]   user
[-]   [-]   user_auth
[+]   [-]   user_auth_token
[-]   [-]   user_role
</code></pre></div><p>Также, чтобы не делать лишней работы предлагаю запустить следующий скрипт для того, что увидеть в какие вообще таблицы мы записываем данные:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat grafana.sql | grep <span style="color:#a31515">&#34;INSERT INTO&#34;</span> | cut -d <span style="color:#a31515">&#39; &#39;</span> -f 3 | uniq | sort
</code></pre></div><p>Перейдем к следующей части программы:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#00f">print</span>(<span style="color:#a31515">&#34;&gt; 5/</span><span style="color:#a31515">%d</span><span style="color:#a31515"> Fixing HEX syntax for &#39;dashboard_snapshot&#39;&#34;</span> % (doings))
    match = re.compile(<span style="color:#a31515">&#34;(?m)(?&lt;=^INSERT INTO dashboard_snapshot VALUES\()(.*)(,X</span><span style="color:#a31515">\&#39;</span><span style="color:#a31515">)([a-fA-F0-9]+</span><span style="color:#a31515">\&#39;</span><span style="color:#a31515">)&#34;</span>, re.IGNORECASE)
    content = match.sub(<span style="color:#a31515">r</span><span style="color:#a31515">&#34;\1,&#39;</span><span style="color:#a31515">\\</span><span style="color:#a31515">x\3&#34;</span>, content)
    <span style="color:#00f">print</span>(<span style="color:#a31515">&#34;✅ Done&#34;</span> + howlong())

    <span style="color:#00f">print</span>(<span style="color:#a31515">&#34;&gt; 6/</span><span style="color:#a31515">%d</span><span style="color:#a31515"> Fixing HEX syntax for &#39;data_keys&#39;&#34;</span> % (doings))
    match = re.compile(<span style="color:#a31515">&#34;(?m)(?&lt;=^INSERT INTO data_keys VALUES\()(.*)(,X</span><span style="color:#a31515">\&#39;</span><span style="color:#a31515">)([a-fA-F0-9]+</span><span style="color:#a31515">\&#39;</span><span style="color:#a31515">)&#34;</span>, re.IGNORECASE)
    content = match.sub(<span style="color:#a31515">r</span><span style="color:#a31515">&#34;\1,&#39;</span><span style="color:#a31515">\\</span><span style="color:#a31515">x\3&#34;</span>, content)
    <span style="color:#00f">print</span>(<span style="color:#a31515">&#34;✅ Done&#34;</span> + howlong())
</code></pre></div><p>Некоторые поля, а также байтовые поля, SQLite оборачивает в поля вида <code>X'[a-fA-F0-9]'</code>. Нам же нужно в тех таблицах, в которых нужно записать байтовое значение, необходимо поменять синтаксис на совместимый с PostgreSQL – <code>'\x[a-fA-F0-9]'</code>. Пользуясь составленным списком вверху, а также списком таблиц в которые мы записываем данные у меня получились талблицы – <code>dashboard_snapshot</code> и <code>data_keys</code> в которые у меня записываются данные, а также в которых содержатся байтовые поля.</p>
<p>Далее все остальные батовые поля вида <code>X'[a-fA-F0-9]'</code> нужно было в текстовым виде записать в PosgtreSQL. Я попробовал сделать это в коде</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#008000"># def hexdecode(hexmatch):</span>
    <span style="color:#008000">#     _hexmatch = hexmatch.group(1)</span>
    <span style="color:#008000">#     _hexstring = bytes.fromhex(_hexmatch[2:-1])</span>
    <span style="color:#008000">#     _hexstring = str(_hexstring)[1:] # delete &#39;b&#39;</span>
    <span style="color:#008000">#     return _hexstring</span>
</code></pre></div><p>Протестировать перекодирование можно вот так:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#008000"># не является кодом основного скрипта</span>
<span style="color:#00f">import</span> re
content = <span style="color:#a31515">&#34;X&#39;48656c6c6f20476f7068657221&#39;&#34;</span>
match = re.compile(<span style="color:#a31515">&#34;(?m)X</span><span style="color:#a31515">\&#39;</span><span style="color:#a31515">([a-fA-F0-9]+)</span><span style="color:#a31515">\&#39;</span><span style="color:#a31515">&#34;</span>, re.IGNORECASE)

<span style="color:#00f">def</span> hexdecode(hexmatch):
    _hexstring = hexmatch.group(1)
    _hexstring = bytes.fromhex(_hexstring)
    _hexstring = _hexstring.decode(<span style="color:#a31515">&#34;ascii&#34;</span>)
    _hexstring = <span style="color:#a31515">&#34;&#39;</span><span style="color:#a31515">%s</span><span style="color:#a31515">&#39;&#34;</span> % (_hexstring)
    <span style="color:#00f">return</span> _hexstring

content = match.sub(hexdecode, content)
<span style="color:#00f">print</span>(content)
</code></pre></div><p>Однако декодирование на уровне Python плохая идея, тк в дальнейшем это ломает экранирование спец символов служащих для разделения полей друг от друга. Полагаю не случайно SQLite эти поля перевел в HEX. И я нашел другое решение.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#00f">def</span> nodecode(hexmatch):
        _hexmatch = hexmatch.group(1)[2:] <span style="color:#008000"># cut X</span>
        _hexmatch = <span style="color:#a31515">&#34;,convert_from(decode(&#34;</span> + _hexmatch + <span style="color:#a31515">&#34;,&#39;hex&#39;),&#39;utf-8&#39;)&#34;</span>
        <span style="color:#00f">return</span> _hexmatch

    <span style="color:#00f">print</span>(<span style="color:#a31515">&#34;&gt; 7/</span><span style="color:#a31515">%d</span><span style="color:#a31515"> Wrapping HEX data&#34;</span> % (doings))
    match = re.compile(<span style="color:#a31515">&#34;(,X</span><span style="color:#a31515">\&#39;</span><span style="color:#a31515">[a-fA-F0-9]*</span><span style="color:#a31515">\&#39;</span><span style="color:#a31515">)&#34;</span>)
    content = match.sub(nodecode, content)
    <span style="color:#00f">print</span>(<span style="color:#a31515">&#34;✅ Done&#34;</span> + howlong())
</code></pre></div><p>Здесь я меняю поля вида <code>X'[a-fA-F0-9]'</code>, на <code>convert_from(decode([a-fA-F0-9],'hex'),'utf-8')</code>. <code>convert_from</code> и <code>decode</code> это встроенные функции PosgreSQL, с помощью которых я могу на лету расшифровать HEX поле и записать его в базу, не делая это в SQL-файле.</p>
<p>Источники:</p>
<ul>
<li><a href="https://overcoder.net/q/222917/hex-%D0%B8-unhex-%D0%B2-mysql-%D1%8D%D0%BA%D0%B2%D0%B8%D0%B2%D0%B0%D0%BB%D0%B5%D0%BD%D1%82%D0%BD%D1%8B-%D0%B2-postgres">HEX () и UNHEX () в MySQL эквивалентны в Postgres?</a></li>
<li><a href="https://gist.github.com/jpetitcolas/5967887">gist jpetitcolas/gist:5967887</a></li>
</ul>
<p>Далее нам нужно составить структуру данных в которых мы обозначим порядковые номера булевых полей в таблицах (для этого мы и готовили список выше).</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    bool_pos = {
        <span style="color:#a31515">&#34;alert&#34;</span>: [13],
        <span style="color:#a31515">&#34;alert_configuration&#34;</span>: [5],
        <span style="color:#a31515">&#34;alert_notification&#34;</span>: [8, 10, 11],
        <span style="color:#a31515">&#34;api_key&#34;</span>: [11],
        <span style="color:#a31515">&#34;dashboard&#34;</span>: [14, 15, 17],
        <span style="color:#a31515">&#34;dashboard_snapshot&#34;</span>: [7],
        <span style="color:#a31515">&#34;data_keys&#34;</span>: [2],
        <span style="color:#a31515">&#34;data_source&#34;</span>: [11, 14, 18, 20],
        <span style="color:#a31515">&#34;migration_log&#34;</span>: [4],
        <span style="color:#a31515">&#34;plugin_setting&#34;</span>: [4, 5],
        <span style="color:#a31515">&#34;role&#34;</span>: [11],
        <span style="color:#a31515">&#34;team_member&#34;</span>: [7],
        <span style="color:#a31515">&#34;user&#34;</span>: [11, 12, 18, 19],
        <span style="color:#a31515">&#34;user_auth_token&#34;</span>: [7],
    }
</code></pre></div><p>Далее я написал конечный автомат с помощью которого могу парсить строку отделять поля друг от друга</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#00f">def</span> list_conv(_match):
        l = []
        state = <span style="color:#a31515">&#34;empty&#34;</span> <span style="color:#008000"># &#34;empty&#34;, &#34;null&#34;, &#34;digit&#34;, &#34;string&#34;, &#34;sqlfunc&#34;</span>
        word = <span style="color:#a31515">&#34;&#34;</span>
        quotes = 0

        <span style="color:#00f">for</span> i <span style="color:#00f">in</span> range(len(_match)):
            match _match[i]:
                case <span style="color:#a31515">&#39;</span><span style="color:#a31515">\&#39;</span><span style="color:#a31515">&#39;</span>:
                    <span style="color:#00f">if</span> state == <span style="color:#a31515">&#34;empty&#34;</span>:
                        state = <span style="color:#a31515">&#34;string&#34;</span>
                    <span style="color:#00f">elif</span> state == <span style="color:#a31515">&#34;string&#34;</span>:
                        <span style="color:#00f">if</span> _match[i-1] != <span style="color:#a31515">&#39;</span><span style="color:#a31515">\\</span><span style="color:#a31515">&#39;</span>:
                            state = <span style="color:#a31515">&#34;empty&#34;</span>
                    word += _match[i]
                case <span style="color:#a31515">&#39;,&#39;</span>:
                    <span style="color:#00f">if</span> state == <span style="color:#a31515">&#34;empty&#34;</span> <span style="color:#00f">or</span> state == <span style="color:#a31515">&#34;digit&#34;</span> <span style="color:#00f">or</span> state == <span style="color:#a31515">&#34;null&#34;</span>:
                        l.append(word)
                        word = <span style="color:#a31515">&#34;&#34;</span>
                        state = <span style="color:#a31515">&#34;empty&#34;</span>
                    <span style="color:#00f">else</span>:
                        word += _match[i]
                case <span style="color:#a31515">&#39;(&#39;</span>:
                    <span style="color:#00f">if</span> state == <span style="color:#a31515">&#34;sqlfunc&#34;</span>:
                        <span style="color:#00f">if</span> _match[i-1] != <span style="color:#a31515">&#39;</span><span style="color:#a31515">\\</span><span style="color:#a31515">&#39;</span>:
                            quotes += 1
                    word += _match[i]
                case <span style="color:#a31515">&#39;)&#39;</span>:
                    <span style="color:#00f">if</span> state == <span style="color:#a31515">&#34;sqlfunc&#34;</span>:
                        <span style="color:#00f">if</span> _match[i-1] != <span style="color:#a31515">&#39;</span><span style="color:#a31515">\\</span><span style="color:#a31515">&#39;</span>:
                            quotes -= 1
                        <span style="color:#00f">if</span> quotes == 0:
                            state = <span style="color:#a31515">&#34;empty&#34;</span>
                    word += _match[i]
                case _:
                    <span style="color:#00f">if</span> state == <span style="color:#a31515">&#34;empty&#34;</span>:
                        <span style="color:#00f">if</span> _match[i].isdigit():
                            state = <span style="color:#a31515">&#34;digit&#34;</span>
                        <span style="color:#00f">elif</span> _match[i].isalpha():
                            <span style="color:#00f">if</span> _match[i] == <span style="color:#a31515">&#34;N&#34;</span>:
                                state = <span style="color:#a31515">&#34;null&#34;</span>
                            <span style="color:#00f">else</span>:
                                state = <span style="color:#a31515">&#34;sqlfunc&#34;</span>


                    word += _match[i]
        l.append(word)
        <span style="color:#00f">return</span> l
</code></pre></div><p>А также функцию для конвертации булевых полей в соотвествующий для PostgreSQL формат.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#00f">def</span> bool_conv(_table, _match):
        splited = list_conv(_match.group(0))
        <span style="color:#00f">global</span> bool_pos
        res = <span style="color:#a31515">&#34;&#34;</span>
        <span style="color:#00f">for</span> i <span style="color:#00f">in</span> bool_pos[_table]:
            match splited[i-1]:
                case <span style="color:#a31515">&#39;0&#39;</span>:
                    splited[i-1] = <span style="color:#a31515">&#34;FALSE&#34;</span>
                case <span style="color:#a31515">&#39;1&#39;</span>:
                    splited[i-1] = <span style="color:#a31515">&#34;TRUE&#34;</span>
                case <span style="color:#a31515">&#39;NULL&#39;</span>:
                    splited[i-1] = <span style="color:#a31515">&#34;NULL&#34;</span>
                case <span style="color:#a31515">&#39;null&#39;</span>:
                    splited[i-1] = <span style="color:#a31515">&#34;NULL&#34;</span>
                case _:
                    <span style="color:#00f">print</span>(<span style="color:#a31515">&#34;Error: This value should be boolean!&#34;</span>)
                    <span style="color:#00f">print</span>(<span style="color:#a31515">&#34;Position: </span><span style="color:#a31515">%s</span><span style="color:#a31515">, value: </span><span style="color:#a31515">%s</span><span style="color:#a31515">&#34;</span> % (i,splited[i-1]))
                    <span style="color:#00f">print</span>(<span style="color:#a31515">&#34;Table: </span><span style="color:#a31515">%s</span><span style="color:#a31515">, data: </span><span style="color:#a31515">%s</span><span style="color:#a31515">&#34;</span> % (_table,splited))
                    exit(1)
        <span style="color:#00f">return</span> <span style="color:#a31515">&#39;,&#39;</span>.join(splited)
</code></pre></div><p>Дело в том, что SQLite на местах где <code>TRUE</code> - выдает нам <code>1</code>, где <code>FALSE</code> – <code>0</code>. При попытке записать ноль и единицу в булево поле в PostgreSQL будет ошибка.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    i = 7 <span style="color:#008000"># doings before</span>
    <span style="color:#00f">for</span> table <span style="color:#00f">in</span> bool_pos:
        i += 1
        <span style="color:#00f">print</span>(<span style="color:#a31515">&#34;&gt; </span><span style="color:#a31515">%d</span><span style="color:#a31515">/</span><span style="color:#a31515">%d</span><span style="color:#a31515"> Fixing boolean values for &#39;</span><span style="color:#a31515">%s</span><span style="color:#a31515">&#39;&#34;</span> % (i, doings, table))
        match = re.compile(<span style="color:#a31515">&#34;(?&lt;=INSERT INTO </span><span style="color:#a31515">%s</span><span style="color:#a31515"> VALUES\().*(?=\);)&#34;</span> % (table), re.IGNORECASE)
        content = match.sub(<span style="color:#00f">lambda</span> match: bool_conv(table, match), content)
        <span style="color:#00f">print</span>(<span style="color:#a31515">&#34;✅ Done&#34;</span> + howlong())
</code></pre></div><p>И собственно перебор всех строк с и приведения в порядок значений булевых полей.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">    print(&#34;&gt; 22/%d Setting quotes above tables name&#34; % (doings))
    match = re.compile(&#34;(?&lt;=INSERT INTO )([\w]+)(?= VALUES\(.*\);)&#34;, re.IGNORECASE)
    content = match.sub(r&#39;&#34;\1&#34;&#39;, content)
    print(&#34;✅ Done&#34; + howlong())
</code></pre></div><p>Предпоследнее действие – взятие в двойные кавычки названия таблиц, опять же продиктовано синтаксисом PostgreSQL.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">    <span style="color:#00f">print</span>(<span style="color:#a31515">&#34;&gt; </span><span style="color:#a31515">%d</span><span style="color:#a31515">/</span><span style="color:#a31515">%d</span><span style="color:#a31515"> Saving result to </span><span style="color:#a31515">%s</span><span style="color:#a31515">&#34;</span> % (doings, doings, resfile))
    <span style="color:#00f">with</span> open(resfile, <span style="color:#a31515">&#39;w&#39;</span>) <span style="color:#00f">as</span> f2:
        f2.write(content)
    <span style="color:#00f">print</span>(<span style="color:#a31515">&#34;🎉 Done&#34;</span> + howlong())
</code></pre></div><p>Ну и финальное действие – сохраняем полученный результат в <code>resfile.sql</code>.</p>
<p>Скрипт целиком вы можете скачать <a href="./grafana_sql_migrator.py">здесь</a>.</p>
<h2 id="инструкция-по-миграции-бд">Инструкция по миграции БД</h2>
<ol>
<li>
<p>Обновляем текущую Grafana до необходимой версии, не меняя используемой базы данных SQLite. Перезагружаем Grafana, ждём чтобы она запустилась, смотрим логи, проверяем работу через WebUI.</p>
</li>
<li>
<p>Переключаем базу на PostgreSQL, запускаем Grafana, ждем пока создасться вся схема БД. Используя графический интерфейс БД или другой копируем схему в файл с набором SQL инструкций (если необходимо удаляем INESERTs, CHANGE и другие инструкций отвечающие за наполнение БД).</p>
</li>
<li>
<p>Выключаем Grafana и конвертируем SQLite БД в набор SQL инструкций.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#008000"># если отсуствует, установите `sqlite3`</span>
sqlite3 grafana.db .dump &gt; grafana.sql
</code></pre></div><blockquote>
<p>Наверное, многие задались вопросом зачем мы сделали файл со схемой БД, когда полученный sql-файл содержит инструкции по созданию схемы. Дело в том, что схема в частности тип полей между SQLite и PostgreSQL немного отличается.</p>
</blockquote>
</li>
<li>
<p>Запускаем скрипт для исправления SQL-файла</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./grafana_sql_migrator.py
</code></pre></div></li>
<li>
<p>Очищаем полностью схему БД, удаляя все таблицы и содержимое.</p>
</li>
<li>
<p>Создаем всю схему БД из подготовленного на 2м шаге файла со схемой:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat ./grafana_schema.sql | psql postgresql://&lt;DBUSER&gt;:&lt;DBPASS&gt;@&lt;DBURL&gt;:&lt;DBPORT&gt;/&lt;DBNAME&gt;
</code></pre></div></li>
<li>
<p>Заполняем БД данными:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat ./resfile.sql | psql postgresql://&lt;DBUSER&gt;:&lt;DBPASS&gt;@&lt;DBURL&gt;:&lt;DBPORT&gt;/&lt;DBNAME&gt; | grep -v <span style="color:#a31515">&#34;INSERT 0 1&#34;</span>
</code></pre></div><blockquote>
<p><code>grep -v &quot;INSERT 0 1&quot;</code> позволит отфильтровать вывод от успешных операций, и отображать только возможные ошибки.</p>
</blockquote>
</li>
<li>
<p>Подготовливаем файл для сброса последовательностей уникальных ключей:</p>
<p>В целом подходов два:</p>
<ol>
<li>
<p>Открыть исходный файл <code>grafana.sql</code> и в его конце найти инструкции по сбросу индексов.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">...
<span style="color:#00f">INSERT</span> <span style="color:#00f">INTO</span> sqlite_sequence <span style="color:#00f">VALUES</span>(<span style="color:#a31515">&#39;org&#39;</span>,1);
<span style="color:#00f">INSERT</span> <span style="color:#00f">INTO</span> sqlite_sequence <span style="color:#00f">VALUES</span>(<span style="color:#a31515">&#39;org_user&#39;</span>,557);
<span style="color:#00f">INSERT</span> <span style="color:#00f">INTO</span> sqlite_sequence <span style="color:#00f">VALUES</span>(<span style="color:#a31515">&#39;preferences&#39;</span>,61);
<span style="color:#00f">INSERT</span> <span style="color:#00f">INTO</span> sqlite_sequence <span style="color:#00f">VALUES</span>(<span style="color:#a31515">&#39;dashboard_tag&#39;</span>,32188);
...
</code></pre></div><p>И увеличив на единицу каждый подготовить соотвествующие инструкции, например:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql">...
<span style="color:#00f">alter</span> sequence migration_log_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 458;
...
</code></pre></div></li>
<li>
<p>Зайти PostgreSQL и запросить какие максимальные индексы находятся сейчас в таблицах, например:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#00f">select</span> <span style="color:#00f">max</span>(id) <span style="color:#00f">from</span> dashboard;
</code></pre></div><p>А затем также подготовить набор инструкций для назначения последовательностей.</p>
<blockquote>
<p>Посмотреть название последовательностей, полей для primary key предлагаю в файле со схемой подговленной в пункте 2.</p>
</blockquote>
</li>
</ol>
<p>Я предлагаю комбинировать и эти два способа, чтобы убедиться, что все корректно.</p>
<p>Забыл сказать, что так как скрипт удаляет данные для таблицы <code>user_auth</code>, мы должны сбросить счетчик <code>user_auth_id_seq</code> на 1. В чем мы собственно убедимся, если будем использовать второй подход.</p>
<p>В итоге должен получиться примерно подобный файл <code>reset_sequence.sql</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#008000">-- reset_sequence.sql
</span><span style="color:#008000"></span><span style="color:#00f">alter</span> sequence migration_log_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 458;
<span style="color:#00f">alter</span> sequence user_id_seq1 <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 566;
<span style="color:#00f">alter</span> sequence dashboard_id_seq1 <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 1740;
<span style="color:#00f">alter</span> sequence dashboard_provisioning_id_seq1 <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 1;
<span style="color:#00f">alter</span> sequence data_source_id_seq1 <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 232;
<span style="color:#00f">alter</span> sequence api_key_id_seq1 <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 12;
<span style="color:#00f">alter</span> sequence dashboard_version_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 1300583;
<span style="color:#00f">alter</span> sequence dashboard_acl_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 6;
<span style="color:#00f">alter</span> sequence login_attempt_id_seq1 <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 1;
<span style="color:#00f">alter</span> sequence org_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 2;
<span style="color:#00f">alter</span> sequence org_user_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 566;
<span style="color:#00f">alter</span> sequence preferences_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 64;
<span style="color:#00f">alter</span> sequence dashboard_tag_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 32470;
<span style="color:#00f">alter</span> sequence plugin_setting_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 4;
<span style="color:#00f">alter</span> sequence annotation_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 186463;
<span style="color:#00f">alter</span> sequence tag_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 16;
<span style="color:#00f">alter</span> sequence user_auth_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 1;
<span style="color:#00f">alter</span> sequence star_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 1009;
<span style="color:#00f">alter</span> sequence team_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 3;
<span style="color:#00f">alter</span> sequence team_member_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 4;
<span style="color:#00f">alter</span> sequence alert_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 660;
<span style="color:#00f">alter</span> sequence dashboard_snapshot_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 3067;
<span style="color:#00f">alter</span> sequence alert_notification_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 24;
<span style="color:#00f">alter</span> sequence alert_notification_state_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 886;
<span style="color:#00f">alter</span> sequence playlist_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 3;
<span style="color:#00f">alter</span> sequence playlist_item_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 6;
<span style="color:#00f">alter</span> sequence temp_user_id_seq1 <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 1;
<span style="color:#00f">alter</span> sequence alert_rule_tag_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 1;
<span style="color:#00f">alter</span> sequence annotation_tag_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 57;
<span style="color:#00f">alter</span> sequence server_lock_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 3;
<span style="color:#00f">alter</span> sequence user_auth_token_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 4497;
<span style="color:#00f">alter</span> sequence short_url_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 851;
<span style="color:#00f">alter</span> sequence alert_rule_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 305;
<span style="color:#00f">alter</span> sequence alert_rule_version_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 305;
<span style="color:#00f">alter</span> sequence alert_configuration_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 2;
<span style="color:#00f">alter</span> sequence role_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 7;
<span style="color:#00f">alter</span> sequence user_role_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 4;
<span style="color:#00f">alter</span> sequence permission_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 5269;
<span style="color:#00f">alter</span> sequence builtin_role_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 4;
<span style="color:#00f">alter</span> sequence secrets_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 117;
<span style="color:#00f">alter</span> sequence kv_store_id_seq <span style="color:#00f">restart</span> <span style="color:#00f">with</span> 4;
</code></pre></div><p>Ну и собственно после исполняем набор этих инструкций в СУБД. Я советую это делать в графическом интерфейсе для работы с СУБД. Но можно и аналогично через утилиту <code>psql</code></p>
</li>
<li>
<p>Включаем Grafana, смотрим логи, проверяем работы WebUI. Миграция завершена.</p>
</li>
</ol>
<h2 id="постскриптум">Постскриптум</h2>
<h3 id="тестирование-регулярных-выражений">Тестирование регулярных выражений</h3>
<ul>
<li>Настоятельно советую использовать сайт <a href="https://regex101.com/">regex101</a></li>
<li>Официальная документация на библиотеку re Python <a href="https://docs.python.org/3/library/re.html">docs.python.org</a></li>
</ul>
<h3 id="многопоточное-запись-в-бд">Многопоточное запись в БД</h3>
<p>Прикольно было бы использовать xargs для многопоточной записи данных в базу, но у меня не хватило времени заставить это работать и я забросил идею. Наработки у меня следующие:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#008000"># printf %s\\n {0..99} | xargs -n 1 -P 8 script-to-run.sh input/ output/</span>
cat ./resfile.sql | tr <span style="color:#a31515">\\</span>n <span style="color:#a31515">\\</span>0 | xargs -0 -P7 psql postgresql://&lt;DBUSER&gt;:&lt;DBPASS&gt;@&lt;DBURL&gt;:&lt;DBPORT&gt;/&lt;DBNAME&gt; | grep -v <span style="color:#a31515">&#34;INSERT 0 1&#34;</span>
</code></pre></div><p>Источники:</p>
<ul>
<li><a href="https://stackoverflow.com/questions/28357997/running-programs-in-parallel-using-xargs">Running programs in parallel using xargs</a></li>
<li><a href="https://stackoverflow.com/questions/40859213/exporting-function-with-xargs-parallel-psql-in-bash">Exporting function with xargs parallel &amp; psql in bash</a></li>
<li><a href="https://www.anycodings.com/1questions/4818800/postgresql-parallel-bulk-insert-with-worker-dont-parallelize">Postgresql parallel bulk INSERT with worker dont parallelize</a></li>
<li><a href="https://gist.github.com/podhy/4bd37e38022fc6ad534a85b8d3e6743e">gist podhy/parallel.sh</a></li>
</ul>
<h3 id="мигрирование-данных-с-grafana-разных-версий">Мигрирование данных с Grafana разных версий</h3>
<p>Сначала я пытался мигрировать данные из Grafana версии 7.5.9 в 9.2.0. Несмотря на то, что схемы отличались немного (в новой версии имелись дополнительные поля в таблицах, что не вызывало проблем при INSERT). Проблема крылась в том, что в Grafana предусмотрен внутренний механизм обновления схемы через таблицу <code>migration_log</code>. И если версия схемы БД отличается от данных в этой таблице, скорее всего будет ошибка при запуске, например:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">lvl=eror msg=“Executing migration failed” logger=migrator id=“copy data_source v1 to v2” error=“pq: column “account_id” does not exist”
</code></pre></div><p>Источник: <a href="https://github.com/grafana/grafana/issues/16720"> bug with upgrade from 6.0.2 to 6.1.3 or 6.1.4 : column account_id does not exist #16720 </a></p>
<p>Поэтому всегда сначала обновляем Grafana до нужно версии на той же базе данных, а лишь затем делаем миграцию данных в другую СУБД.</p>

            </div>

            <div class="tags">
                 
                <ul class="flat">
                    
                    <li><a href="/tags/ru">ru</a></li>
                    
                    <li><a href="/tags/programming">programming</a></li>
                    
                </ul>
                 
            </div>

<br/>
<script defer src="https://commento.urpylka.com/js/commento.js" data-css-override="/css/commento.css"></script>
<div id="commento"></div>
<noscript>Please enable JavaScript to load the comments.</noscript></div>
    </div>
    <div class="footer wrapper">
	<nav class="nav">
		<div>2022  © Artem Smirnov |  <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div><script>feather.replace()</script>
</body>

</html>