<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Прошивка Arduino через USB (UART) / AVR ISP разъём (USBasp программатор) – urpylka՚s blog!</title><link rel="icon" type="image/x-icon" href="https://urpylka.com/favicon.ico" />
	<link rel="apple-touch-icon" sizes="57x57" href="https://urpylka.com/favicon/apple-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="https://urpylka.com/favicon/apple-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="https://urpylka.com/favicon/apple-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="https://urpylka.com/favicon/apple-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="https://urpylka.com/favicon/apple-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="https://urpylka.com/favicon/apple-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144" href="https://urpylka.com/favicon/apple-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152" href="https://urpylka.com/favicon/apple-icon-152x152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="https://urpylka.com/favicon/apple-icon-180x180.png">
	<link rel="icon" type="image/png" sizes="192x192"  href="https://urpylka.com/favicon/android-icon-192x192.png">
	<link rel="icon" type="image/png" sizes="32x32" href="https://urpylka.com/favicon/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="96x96" href="https://urpylka.com/favicon/favicon-96x96.png">
	<link rel="icon" type="image/png" sizes="16x16" href="https://urpylka.com/favicon/favicon-16x16.png">
	<link rel="manifest" href="https://urpylka.com/favicon/manifest.json">
	<meta name="msapplication-TileColor" content="#ffffff">
	<meta name="msapplication-TileImage" content="https://urpylka.com/favicon/ms-icon-144x144.png">
	<meta name="theme-color" content="#ffffff"><meta name="viewport" content="width=device-width, initial-scale=1"><meta itemprop="name" content="Прошивка Arduino через USB (UART) / AVR ISP разъём (USBasp программатор)">
<meta itemprop="description" content="Эта заметка нацелена на изложение основных действий для перепрошивки Arduino с помощью встроенного бутлодера и программатора.">
<meta itemprop="datePublished" content="2022-02-26T23:55:00&#43;02:00" />
<meta itemprop="dateModified" content="2022-02-26T23:55:00&#43;02:00" />
<meta itemprop="wordCount" content="640">



<meta itemprop="keywords" content="ru,programming,electronics," /><meta property="og:title" content="Прошивка Arduino через USB (UART) / AVR ISP разъём (USBasp программатор)" />
<meta property="og:description" content="Эта заметка нацелена на изложение основных действий для перепрошивки Arduino с помощью встроенного бутлодера и программатора." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://urpylka.com/posts/post-69/" />
<meta property="article:published_time" content="2022-02-26T23:55:00+02:00" />
<meta property="article:modified_time" content="2022-02-26T23:55:00+02:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Прошивка Arduino через USB (UART) / AVR ISP разъём (USBasp программатор)"/>
<meta name="twitter:description" content="Эта заметка нацелена на изложение основных действий для перепрошивки Arduino с помощью встроенного бутлодера и программатора."/>
<link rel="stylesheet" type="text/css" media="screen" href="https://urpylka.com/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://urpylka.com/css/main.css" />
	<link rel="stylesheet" type="text/css" id="dark-scheme" href="https://urpylka.com/css/dark.css" />
	<link rel="stylesheet" type="text/css" href="https://urpylka.com/css/medium-font.css" />
<script type="text/javascript" >
	(function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
	m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
	(window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
ym("62022457", "init", {
        clickmap:true,
        trackLinks:true,
        accurateTrackBounce:true,
        webvisor:true
});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/62022457" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-163829261-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

	<script src="https://urpylka.com/js/feather.min.js"></script><script src="https://urpylka.com/js/main.js"></script></head>


<body>
    <div class="container wrapper">
        <div class="header"><div class="flex-block">
		<div class="site-title"><a href="https://urpylka.com/">urpylka՚s blog!</a></div>
		<nav class="nav ico">
			<ul class="flat"><li><a href="https://github.com/urpylka" title="Github"><i data-feather="github"></i></a></li><li><a href="https://instagram.com/urpylka" title="Instagram"><i data-feather="instagram"></i></a></li><li class="edge-left"><span class="scheme-toggle"><a href="#" id="scheme-toggle"></a></span></li>
			</ul>
		</nav>
	</div><p id="subtitle">Programming, robotics, traveling</p><nav class="nav menu">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">Posts</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


        <div class="post one">
            <div class="post-header">
                
                <div class="meta">
                    <div class="date">
                        <span class="day">26</span>
                        <span class="rest">Feb 2022</span>
                    </div>
                </div>
                
                <div class="matter">
                    <h1 class="title">Прошивка Arduino через USB (UART) / AVR ISP разъём (USBasp программатор)</h1>
                </div>
            </div>

            <div class="markdown">
                <p>Эта заметка нацелена на изложение основных действий для перепрошивки Arduino как при помощи встроенного бутлодера, так и с помощью программатора. В первых двух разделах я коротко изложу техническую базу и особенности использования двух методов, а в третьем разделе среду разработки и утилиты необхоидмые для прошивки.</p>
<h2 id="прошивка-с-помощью-встроенного-bootloader-через-последовательный-порт">Прошивка с помощью встроенного bootloader (через последовательный порт)</h2>
<p>Все платы Arduino (основная линейка) построены на базе чипа Atmega с архитектурой AVR. AVR – это семейство микроконтроллеров, их прошивка, а именно запись постоянной памяти и выставление Fuse битов реализовано через ICSP порт очень похожий на SPI. Однако наиболее распространенным способом прошивки является прошивка через USB. Точнее через UART, тк на самом деле на плате разведён USB-RS232 преобразователь.</p>
<blockquote>
<p>RS232 это надстройка над UART. UART содержит только пины <code>RX</code>, <code>TX</code>. Тогда как RS232 содержит ещё и другие линии (подробнее на <a href="https://zen.yandex.ru/media/tehnozet2/uart-comport-rs232-chto-eto-i-kak-oni-sviazany-60093adf9444cb7e98c63dbb">UART, COM-порт, RS-232, что это и как они связаны?</a>):</p>
<p><img src="./images/db9m-rs232-pinout.jpg" alt="image"></p>
</blockquote>
<p>Для перепрошивки через UART требуется выполнение двух условий:</p>
<ol>
<li>Наличие загрузчика в МК (его вполне может и не быть там, тогда остается только вариант с прошивкой через программатор)</li>
<li>Для начала загрузки прошивки необходимо перезагрузить МК в очень узкое временное окно и затем начать передавать прошивку через UART. На некоторых платах отсуствует встроенный USB-RS232 преобразователь, например <code>Arduino Pro Mini</code>. В этом случае вы можете попробовать перезагрузить МК с кнопки на плате Arduino (у меня это получилось раза 20го). Как альтернатива, если вы используете внешний USB-RS232 преобразователь с линией <code>DTR</code>. Вы можете подключить этот вывод на пин <code>RESET</code> Arduino. Аналогичным способом подключен встроенный преразователь на Arduino.</li>
</ol>
<p>Для начала разберемся с тем, что нужно постоянно искать – пинами на программаторе.</p>
<h2 id="прошивка-с-помощью-программатора">Прошивка с помощью программатора</h2>
<p>Есть множество различных программаторов, я использую <code>USBASP</code> (<a href="https://microkontroller.ru/programmirovanie-mikrokontrollerov-avr/usbasp-usb-avr-programmator/">USBASP: USB AVR программатор для микроконтроллеров ATmega, ATtiny</a>). Также в качестве программатора можно использовать ещё одну плату Arduino со специальной прошивкой.</p>
<p>Все сложность в прошивки этим способом обеспечить корректное подключение программатора к Arduino. Также обратите внимание, что лучше запитать Arduino непосредственно от программатора.</p>
<p>Основная проблема в том, что на большинстве программаторов ICSP-разъём содержит 10 пинов, тогда как на всех платах Arduino, и не только, он 6ти пиновый.</p>
<p><img src="./images/iscp.jpg" alt="image"></p>
<p>Для прототипирования небольших проектов, я люблю использовать <code>Arduino Nano</code>, ниже описание выводов:</p>
<p><img src="./images/arduino-nano-3.2.jpg" alt="image"></p>
<p>На некоторых программаторах, в том числе на USBasp выведены также I2C, UART-линии:</p>
<p><img src="./images/atb-usbasp.png" alt="image"></p>
<p>Для облегчения процесса перепрошивки, может быть сделан переходник. Подробнее в статье <a href="http://bigbenmobileblog.blogspot.com/2014/01/avr-isp.html">AVR ISP Разъемы</a> (<a href="http://web.archive.org/web/20200808204440/http://bigbenmobileblog.blogspot.com/2014/01/avr-isp.html">webarchive</a>).</p>
<blockquote>
<p>Иногда при прошивке с помощью программатора возникает ошибка <code>avrdude: warning: cannot set sck period, please check for usbasp firmware update</code>, при этом она может вызвана двумя причинами:</p>
<ol>
<li>Плохой контакт тактирующего сигнала <code>SCK</code>.</li>
<li>Устаревшая прошивка на программаторе, подробнее как её обновить тут <a href="https://tsibrov.blogspot.com/2018/10/usbasp-firmware-update.html">Прошивка USBasp</a>.</li>
</ol>
</blockquote>
<h2 id="среда-разработки-и-прошивка">Среда разработки и прошивка</h2>
<p>Стандартная среда разработки Arduino IDE включает в себя:</p>
<ol>
<li>Магазин библиотек</li>
<li>Текстовый редактор</li>
<li>Набор драйвером для сериал портов (последовательных портов)</li>
<li>Монитор последовательного порта</li>
<li>Обертку над <code>avrdude</code></li>
<li>Компилятор</li>
</ol>
<p>По сути весь процесс прошивки заключается в запуске <code>avrdude</code> с разными аргументами. Мне не нравится среда <code>Arduino IDE</code> ввиду крайне неудобного редактора при открытии нескольких файлов.</p>
<p>Я использую в качество основного редактора кода VSCode, для него есть замечательный плагин <code>Platformio</code>, который позволяет производить сборку, а также прошивку устройств через встроенный загрузчик. Однако для перепрошивки, а также для работы с последовательным интерфейсом я предпочитаю использовать напрямую утилиты <code>avrdude</code> и <code>screen</code>. Для этого я добавляю в репозиторий примерно следующий <code>Makefile</code>:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Makefile" data-lang="Makefile">all: upload

upload:
	platformio run --target upload

clean:
	platformio run --target clean

build:
	platformio run

list:
	ls -l /dev/tty.*

monitor:
	screen /dev/tty.usbserial-AH05WAKX 115200

usbasp:
	avrdude -c usbasp -p m328p -P usb -U flash:w:.pio/build/ATmega328P/firmware.hex:i -FD

direct:
	avrdude -c arduino -p m328p -U flash:w:.pio/build/ATmega328P/firmware.hex:i -P /dev/tty.usbserial-AH05WAKX

info:
	avrdude -c usbasp -p m328p -P usb -v

setup:
	brew install avrdude screen
</code></pre></div><blockquote>
<p>Адрес последовательного интерфейса может отличаться, также цель <code>setup</code> использует пакетный менеджер <code>brew</code> для установки зависимостей на macOS.</p>
</blockquote>
<p>Библиотеки я предпочитаю лично контролировать включением их в репозиторий, для этого в проекте Platformio необходимо создать папку <code>lib</code>.</p>
<hr>
<p>Пожалуй, это основные лайфхаки которые я использую для прошивки Arduino. Я умышленно упросил и недосказал некоторые моменты, возможно я допишу это когда-нибудь.</p>

            </div>

            <div class="tags">
                 
                <ul class="flat">
                    
                    <li><a href="/tags/ru">ru</a></li>
                    
                    <li><a href="/tags/programming">programming</a></li>
                    
                    <li><a href="/tags/electronics">electronics</a></li>
                    
                </ul>
                 
            </div>

<br/>
<script defer src="https://commento.urpylka.com/js/commento.js" data-css-override="/css/commento.css"></script>
<div id="commento"></div>
<noscript>Please enable JavaScript to load the comments.</noscript></div>
    </div>
    <div class="footer wrapper">
	<nav class="nav">
		<div>2022  © Artem Smirnov |  <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div><script>feather.replace()</script>
</body>

</html>